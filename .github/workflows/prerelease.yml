# name of the action
name: prerelease

# trigger on release events
on:
  release:
    types: [created]

permissions:
  contents: read

# pipeline to execute
jobs:
  prerelease:
    runs-on: ubuntu-latest

    permissions:
      contents: write # for actions/github-script to upload release assets

    steps:
      - name: clone
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          # ensures we fetch tag history for the repository
          fetch-depth: 0

      - name: install go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          # use version from go.mod file
          go-version-file: "go.mod"
          cache: true
          check-latest: true

      - name: build
        run: ./release.sh

      - name: upload binaries
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          retries: 3
          script: |
            const fs = require('fs');
            const path = require('path');

            const files = [
              "release/vela_checksums.txt",
              "release/vela_darwin_amd64.tar.gz",
              "release/vela_darwin_arm64.tar.gz",
              "release/vela_linux_amd64.tar.gz",
              "release/vela_linux_arm64.tar.gz",
              "release/vela_linux_arm.tar.gz",
              "release/vela_windows_amd64.tar.gz"
            ];

            for (const file of files) {
              try {
                if (!fs.existsSync(file)) {
                  core.warning(`File not found: ${file}`);
                  continue;
                }

                const fileContent = fs.readFileSync(file);
                const fileName = path.basename(file);

                core.info(`Uploading ${fileName}...`);

                const response = await github.rest.repos.uploadReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: context.payload.release.id,
                  name: fileName,
                  data: fileContent,
                });

                core.info(`Uploaded Asset: ${fileName} (${response.data.browser_download_url})`);
              } catch (error) {
                core.error(`Failed to upload ${file}: ${error.message}`);
                throw error;
              }
            }

      - name: login to dockerhub
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: extract metadata
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: target/vela-cli
          tags: |
            # only on push tag, "raw" because {{version}} strips "v" prefix
            type=semver,pattern={{raw}}

      - name: build and push image
        id: push
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
